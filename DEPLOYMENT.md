# Deploying IronTrack Backend to Render.com

This guide explains how to deploy the IronTrack backend API to Render.com using the included configuration files.

## Prerequisites

- A [Render.com](https://render.com) account
- Your code pushed to a GitHub repository
- A Google Gemini API key (get one from [Google AI Studio](https://makersuite.google.com/app/apikey))

## Quick Deploy with render.yaml

The easiest way to deploy is using the included `render.yaml` configuration file.

### Option 1: Deploy via Render Dashboard (Recommended)

1. **Connect your GitHub repository** to Render:
   - Go to [Render Dashboard](https://dashboard.render.com/)
   - Click "New +" → "Blueprint"
   - Connect your GitHub account and select this repository
   - Render will automatically detect the `render.yaml` file

2. **Configure environment variables**:
   - `JWT_SECRET` - Will be auto-generated by Render
   - `GEMINI_API_KEY` - **You must provide this** (get it from Google AI Studio)
   - `DATABASE_PATH` - Already set to `/data/irontrack.db` in render.yaml

3. **Review the configuration**:
   - Service Type: Web Service
   - Runtime: Docker
   - Plan: Starter (you can change this)
   - Persistent Disk: 1GB mounted at `/data` (for SQLite database)

4. **Deploy**: Click "Apply" and Render will build and deploy your service

### Option 2: Manual Setup

If you prefer to set up manually without the blueprint:

1. **Create a new Web Service**:
   - Go to Render Dashboard → "New +" → "Web Service"
   - Connect your repository

2. **Configure the service**:
   - **Name**: irontrack-backend
   - **Runtime**: Docker
   - **Branch**: main (or your default branch)
   - **Plan**: Starter or higher

3. **Add environment variables**:
   ```
   JWT_SECRET=<auto-generate or use your own>
   GEMINI_API_KEY=<your-api-key-here>
   DATABASE_PATH=/data/irontrack.db
   ALLOWED_ORIGINS=https://your-frontend-domain.com
   GIN_MODE=release
   ```

4. **Add a persistent disk**:
   - Go to "Disks" section
   - Click "Add Disk"
   - Name: irontrack-data
   - Mount Path: `/data`
   - Size: 1GB (or more if needed)

5. **Deploy**: Click "Create Web Service"

## Environment Variables

| Variable | Description | Required | Default |
|----------|-------------|----------|---------|
| `PORT` | Server port (auto-set by Render) | No (auto) | 8080 |
| `JWT_SECRET` | Secret key for JWT token signing | Yes | - |
| `GEMINI_API_KEY` | Google Gemini API key for AI features | Yes | - |
| `DATABASE_PATH` | Path to SQLite database file | No | irontrack.db |
| `ALLOWED_ORIGINS` | Comma-separated list of allowed CORS origins | No | * (all) |
| `GIN_MODE` | Gin framework mode (release/debug) | No | debug |

## Persistent Storage

The SQLite database is stored on Render's persistent disk at `/data/irontrack.db`. This ensures your data persists across deployments and restarts.

**Important**: 
- The disk is mounted at `/data`
- Database migrations run automatically on startup
- Back up your database regularly (download via Render Shell)

## Testing Your Deployment

### Health Check

Test the health endpoint (useful for monitoring):
```bash
curl https://your-service-name.onrender.com/health
```

Expected response:
```json
{"status":"healthy","service":"irontrack-backend"}
```

### API Test

Test user registration available at: `https://your-service-name.onrender.com`

Test the health of your service:
```bash
curl https://your-service-name.onrender.com/api/register -X POST \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123","name":"Test User"}'
```

## Local Development with Docker

To test the Docker build locally:

```bash
# Build the image
docker build -t irontrack-backend .

# Run the container
docker run --rm -p 8080:8080 \
  -e JWT_SECRET=your-secret-key \
  -e GEMINI_API_KEY=your-api-key \
  irontrack-backend
```

The server will be available at `http://localhost:8080`

## Database Backups

To backup your SQLite database from Render:

1. Go to your service in Render Dashboard
2. Click "Shell" to open a terminal
3. Run: `cat /data/irontrack.db > /tmp/backup.db`
4. Download the backup file

## Troubleshooting

### Build Fails
- Check that all required Set `ALLOWED_ORIGINS` environment variable to your frontend domain(s) (e.g., `https://myapp.com,https://www.myapp.com`)
- **Monitoring**: Set up Render's built-in monitoring and alerts, use `/health` endpoint for health check
### Database Not Persisting
- Ensure the persistent disk is mounted at `/data`
- Verify `DATABASE_PATH` environment variable is set to `/data/irontrack.db`

### API Returns 500 Errors
- Check the logs in Render Dashboard
- Verify `GEMINI_API_KEY` is set correctly
- Ensure `JWT_SECRET` is configured

## Next Steps

- **CORS Configuration**: Update allowed origins in [internal/router/router.go](internal/router/router.go) to restrict access to your frontend domain
- **Production Mode**: Set `GIN_MODE=release` environment variable for production
- **Monitoring**: Set up Render's built-in monitoring and alerts
- **Custom Domain**: Add your custom domain in Render Dashboard
