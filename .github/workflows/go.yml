name: Deploy IronTrack to DigitalOcean

on:
  push:
    branches:
      - master  # Âè™Âú® main ÂàÜÊîØ push Êó∂Ëß¶Âèë

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build Linux binary
        run: |
          mkdir -p build
          LDFLAGS="-X main.GitCommit=${GITHUB_SHA:0:7} -X main.BuildTime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          GOOS=linux GOARCH=amd64 go build -ldflags "$LDFLAGS" -o build/irontrack ./cmd/server

      - name: Stop service before deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script_stop: false
          script: |
            if systemctl is-active --quiet irontrack.service; then
              echo "üõë Stopping irontrack..."
              systemctl stop irontrack
            else
              echo "‚ö†Ô∏è irontrack.service not running or not found, skipping stop."
            fi

      - name: Upload new binary
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          source: "build/irontrack"
          target: "/srv/"
          overwrite: true

      - name: Start service after deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script_stop: false
          script: |
            echo "üöÄ Starting irontrack..."
            systemctl start irontrack
            systemctl status irontrack --no-pager

      - name: Health Check & Version Verification
        run: |
          SHORT_SHA=${GITHUB_SHA:0:7}
          echo "üîç Checking health and version $SHORT_SHA at https://b.momane.com/health..."
          # Try up to 5 times with 10s delay
          for i in {1..5}; do
            RESPONSE=$(curl -s https://b.momane.com/health)
            if echo "$RESPONSE" | grep -q '"status":"healthy"' && echo "$RESPONSE" | grep -q "\"version\":\"$SHORT_SHA\""; then
              echo "‚úÖ Health check and version verification passed: $RESPONSE"
              exit 0
            fi
            echo "‚è≥ Waiting for service to be healthy and updated (attempt $i/5)..."
            echo "Current response: $RESPONSE"
            sleep 10
          done
          echo "‚ùå Health check or version verification failed after 5 attempts"
          exit 1
